<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" sizes="16x16 32x32 48x48" href="/assets/favicon/favicon.ico">
    <link rel="apple-touch-icon" href="/assets/favicon/apple-touch-icon.png"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Создание массивов в C#: способы и производительность | alexeyfv</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Создание массивов в C#: способы и производительность" />
<meta name="author" content="© 2024 Alexey Fedorov" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Как создать массив в C#? Вопрос кажется простым. Но с каждой новой версией .NET появляются всё новые и новые фичи. На данный момент я знаю аж 7 способов создания массивов." />
<meta property="og:description" content="Как создать массив в C#? Вопрос кажется простым. Но с каждой новой версией .NET появляются всё новые и новые фичи. На данный момент я знаю аж 7 способов создания массивов." />
<link rel="canonical" href="http://www.alexeyfv.xyz//2024/09/05/create-array.html" />
<meta property="og:url" content="http://www.alexeyfv.xyz//2024/09/05/create-array.html" />
<meta property="og:site_name" content="alexeyfv" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-09-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Создание массивов в C#: способы и производительность" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"© 2024 Alexey Fedorov"},"description":"Как создать массив в C#? Вопрос кажется простым. Но с каждой новой версией .NET появляются всё новые и новые фичи. На данный момент я знаю аж 7 способов создания массивов.","@type":"BlogPosting","headline":"Создание массивов в C#: способы и производительность","dateModified":"2024-09-05T00:00:00+00:00","datePublished":"2024-09-05T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.alexeyfv.xyz//2024/09/05/create-array.html"},"url":"http://www.alexeyfv.xyz//2024/09/05/create-array.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://www.alexeyfv.xyz//feed.xml" title="alexeyfv" />
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">alexeyfv</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tags/">Tags</a><a class="page-link" href="/cv/">CV</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article
  class="post h-entry"
  itemscope
  itemtype="http://schema.org/BlogPosting"
>
  <link rel="stylesheet" href="/static/glide/css/glide.core.min.css" />
  <link rel="stylesheet" href="/static/glide/css/glide.theme.min.css" />
  <script type="text/javascript" src="/static/glide/glide.min.js"></script>
  <link href="/static/syntax-highlighting.css" rel="stylesheet" />
  <link href="/static/image.css" rel="stylesheet" />
  <script>
    function initGlideCarousel() {
      var sliders = document.querySelectorAll(".glide");
      const conf = {};
      sliders.forEach((item) => {
        new Glide(item, conf).mount();
      });
    }
    document.addEventListener("DOMContentLoaded", initGlideCarousel);
  </script>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">
      Создание массивов в C#: способы и производительность
    </h1>
    <p class="post-meta"><time
        class="dt-published"
        datetime="2024-09-05T00:00:00+00:00"
        itemprop="datePublished"
      >
        Sep 5, 2024
      </time></p>
    
    <a class="post" href="/tag/csharp">#csharp</a>
    
    <a class="post" href="/tag/performance">#performance</a>
    
    <a class="post" href="/tag/benchmark">#benchmark</a>
    
    <a class="post" href="/tag/array">#array</a>
    
  </header>

  <div class="post-content e-content" itemprop="articleBody"><p>Как создать массив в C#? Вопрос кажется простым. Но с каждой новой версией .NET появляются всё новые и новые фичи. На данный момент я знаю аж 7 способов создания массивов.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">new T[]</code>. Самый очевидный, простой и популярный способ создания объектов и массивов в частности. Этот оператор используется повсеместно и является основным для большинства сценариев.</li>
</ol>

<p><img src="/assets/2024/09/2024-09-05-create-array/image01.png" alt="content" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">stackalloc T[]</code>. Выделяет память в стеке для массива заданного размера и возвращает указатель. Когда-то давно оператор stackalloc требовал использования небезопасного (unsafe) контекста. С появлением <code class="language-plaintext highlighter-rouge">Span&lt;T&gt;</code> его можно применять и без unsafe. Этот способ ограничен размером доступной памяти в стеке и при необдуманном использовании может привести к <code class="language-plaintext highlighter-rouge">StackOverflowException</code>.</li>
</ol>

<p><img src="/assets/2024/09/2024-09-05-create-array/image02.png" alt="content" /></p>

<p>Для небольших массивов stackalloc T[] быстрее new T[] в среднем на 20% и на 88% для больших массивов. Под небольшими массивами я подразумеваю массивы размером меньше 85 000 байт, т.е. размещаемые в куче малых объектов (SOH), а под большими – в куче больших объектов (LOH).</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">ArrayPool&lt;T&gt;</code>. ArrayPool выделяет массив из пула, что минимизирует количество аллокаций памяти и уменьшает нагрузку на сборщик мусора. Массивы, возвращаемые из пула, могут быть больше запрошенного размера, например, для массива из 700 элементов будет возвращён массив длиной 1024. Использование пула полезно, для относительно больших временных массивов, которые часто создаются и уничтожаются.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">ArrayPool&lt;T&gt;</code> быстрее <code class="language-plaintext highlighter-rouge">new T[]</code> в среднем на 30% для небольших массивов и на 89% для больших массивов. Однако для массивов размером менее 300–400 байт использование пула может быть медленнее.</p>

<p><img src="/assets/2024/09/2024-09-05-create-array/image03.png" alt="content" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">GC.AllocateUninitializedArray&lt;T&gt;</code>. Этот метод создаёт массив без инициализации его элементов значениями по умолчанию. Использование этого метода может быть небезопасным, так как массив содержит неинициализированные данные. Обязательно перезаписывайте все значения в созданном массиве.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">GC.AllocateUninitializedArray&lt;T&gt;</code> быстрее <code class="language-plaintext highlighter-rouge">new T[]</code> в среднем на 15% для массивов 2048 – 85 000 байт. В остальных случаях производительность с <code class="language-plaintext highlighter-rouge">new T[]</code> одинаковая.</p>

<p><img src="/assets/2024/09/2024-09-05-create-array/image04.png" alt="content" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Array.Initialize</code>. Позволяет создавать массивы, задавая тип во время выполнения. Например, когда тип неизвестен на этапе компиляции. Полезно для сценариев, связанных с динамической типизацией.</li>
</ol>

<p>Производительность аналогична <code class="language-plaintext highlighter-rouge">new T[]</code>, либо хуже.</p>

<p><img src="/assets/2024/09/2024-09-05-create-array/image05.png" alt="content" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">InlineArrayAttribute</code>. Относительно новая фича, появившаяся в C# 12. Позволяет объявить структуру с атрибутом <code class="language-plaintext highlighter-rouge">InlineArray</code>, которая затем будет вести себя как массив.</li>
</ol>

<p>Быстрее <code class="language-plaintext highlighter-rouge">new T[]</code> в среднем на 39% для небольших массивов и на 91% для больших массивов.</p>

<p><img src="/assets/2024/09/2024-09-05-create-array/image06.png" alt="content" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">collections expressions</code>. Синтаксический сахар, который позволяет записать массив в виде литерала. Например, <code class="language-plaintext highlighter-rouge">int[] array = [1, 2, 3]</code> создаёт массив в куче, аналогично использованию <code class="language-plaintext highlighter-rouge">new T[]</code>. А конструкция <code class="language-plaintext highlighter-rouge">Span&lt;int&gt; array = [1, 2, 3]</code> создаёт массив в стеке, аналогично <code class="language-plaintext highlighter-rouge">stackalloc</code>.</li>
</ol>

<p><img src="/assets/2024/09/2024-09-05-create-array/image07.png" alt="content" /></p>

<p>Код бенчмарка и результаты <a href="https://github.com/alexeyfv/create-array">тут</a>.</p>
</div><a class="u-url" href="/2024/09/05/create-array.html" hidden></a>
</article>

<script
  src="https://utteranc.es/client.js"
  repo="alexeyfv/blog"
  issue-term="url"
  label="comment"
  theme="github-dark"
  crossorigin="anonymous"
  async
></script>

      </div>
    </main><footer class="site-footer h-card">
    <data class="u-url" href="/"></data>
  
    <div class="wrapper">
  
      <div class="footer-col-wrapper">
        <div class="footer-col">
          <ul class="contact-list">
            <li class="p-name">© 2024 Alexey Fedorov</li>
              <li class="p-name">Powered by
                <a href="https://github.com/jekyll/jekyll">Jekyll</a> 
                &
                <a href="https://github.com/jekyll/minima">Minima</a>
              </li>
            </ul>
        </div>
        <div class="footer-col">
          <p>Articles about .NET, C# and much more</p>
        </div>
      </div>
  
      <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/alexeyfv" target="_blank" title="alexeyfv"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/alexeyfv" target="_blank" title="alexeyfv"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://t.me/alexeyfv" target="_blank" title="alexeyfv"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#telegram"></use></svg></a></li></ul></div>
  
    </div>
  
  </footer></body>

</html>
